var J=Object.create;var v=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var R=n=>v(n,"__esModule",{value:!0}),a=(n,r)=>v(n,"name",{value:r,configurable:!0});var B=(n,r)=>{for(var e in r)v(n,e,{get:r[e],enumerable:!0})},U=(n,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of j(r))!z.call(n,o)&&(e||o!=="default")&&v(n,o,{get:()=>r[o],enumerable:!(t=P(r,o))||t.enumerable});return n},w=(n,r)=>U(R(v(n!=null?J(Y(n)):{},"default",!r&&n&&n.__esModule?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n),G=(n=>(r,e)=>n&&n.get(r)||(e=U(R({}),r,1),n&&n.set(r,e),e))(typeof WeakMap!="undefined"?new WeakMap:0);var ne={};B(ne,{Music:()=>b,TTScraper:()=>l,TikTokResult:()=>I,User:()=>f,Video:()=>p,fetchAllVideosFromUser:()=>te,fetchMusic:()=>re,fetchUser:()=>ee,fetchVideo:()=>Z,fetchVideoNoWaterMark:()=>oe,hashtag:()=>ie});var E=w(require("cheerio")),x=w(require("miniget")),T=w(require("node-fetch")),h=require("fs"),V=w(require("puppeteer")),S=w(require("http")),N=w(require("https")),O=require("process");var f=class{constructor(r,e,t,o,i,u,d,c,s,g,k,_,A,M){this.id=r,this.uniqueId=e,this.nickname=t,this.avatar=o,this.signature=i,this.createdAt=u,this.verified=d,this.secretUID=c,this.bioLink=s,this.privateAccount=g,this.followers=k,this.following=_,this.hearts=A,this.videos=M}};a(f,"User");var I=class{constructor(r,e,t,o,i,u,d,c,s,g){this.author=r,this.video=e,this.audio=t,this.shareCount=o,this.likesCount=i,this.commentCount=u,this.playCount=d,this.createdAt=c,this.tiktokLink=s,this.thumbnail=g}};a(I,"TikTokResult");var p=class{constructor(r,e,t,o,i,u,d,c,s,g,k,_,A,M,D,q,W,F){this.id=r,this.description=e,this.createdAt=t,this.height=o,this.width=i,this.duration=u,this.resolution=d,this.shareCount=c,this.likesCount=s,this.commentCount=g,this.playCount=k,this.downloadURL=_,this.cover=A,this.dynamicCover=M,this.playURL=D,this.format=q,this.author=W,this.directVideoUrl=F}};a(p,"Video");var b=class{constructor(r,e,t,o,i,u,d,c,s){this.id=r,this.title=e,this.playURL=t,this.coverLarge=o,this.coverThumb=i,this.author=u,this.duration=d,this.original=c,this.album=s}};a(b,"Music");var $=require("netscape-cookies-parser");var L=w(require("node-fetch")),H=require("tiktok-signature"),K="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.56",X="https://www.tiktok.com/api/post/item_list/?aid=1988&app_language=en&app_name=tiktok_web&battery_info=1&browser_language=en-US&browser_name=Mozilla&browser_online=true&browser_platform=Win32&browser_version=5.0%20%28Windows%20NT%2010.0%3B%20Win64%3B%20x64%29%20AppleWebKit%2F537.36%20%28KHTML%2C%20like%20Gecko%29%20Chrome%2F107.0.0.0%20Safari%2F537.36%20Edg%2F107.0.1418.56&channel=tiktok_web&cookie_enabled=true&device_id=7165118680723998214&device_platform=web_pc&focus_state=true&from_page=user&history_len=3&is_fullscreen=false&is_page_visible=true&os=windows&priority_region=RO&referer=&region=RO&screen_height=1440&screen_width=2560&tz_name=Europe%2FBucharest&webcast_language=en&msToken=G3C-3f8JVeDj9OTvvxfaJ_NppXWzVflwP1dOclpUOmAv4WmejB8kFwndJufXBBrXbeWNqzJgL8iF5zn33da-ZlDihRoWRjh_TDSuAgqSGAu1-4u2YlvCATAM2jl2J1dwNPf0_fk9dx1gJxQ21S0=&X-Bogus=DFSzswVYxTUANS/JS8OTqsXyYJUo&_signature=_02B4Z6wo00001CoOkNwAAIDBCa--cQz5e0wqDpRAAGoE8f",y={aid:"1988",count:35,secUid:"",cursor:"",cookie_enabled:!0,screen_width:0,screen_height:0,browser_language:"",browser_platform:"",browser_name:"",browser_version:"",browser_online:"",timezone_name:"Europe/London"};async function C(n,r){y.secUid=n,y.cursor=r;let e=new H(null,K);await e.init();let i=`https://m.tiktok.com/api/post/item_list/?${new URLSearchParams(y).toString()}`,u=await e.sign(i),d=await e.navigator();await e.close();let{"x-tt-params":c}=u,{user_agent:s}=d,g=await Q(s,c);if(g.status!==200)throw new Error("A request to get the user's videos was not successful!");return await g.json()}a(C,"getUserVideos");async function Q(n,r){return await(0,L.default)(X,{method:"GET",headers:{"user-agent":n,"x-tt-params":r}})}a(Q,"fetchVideos");var l=class{constructor(r){this._cookiesJar=new $.CookieJar;r?this._cookies=this._cookiesJar.load(r):this._cookies=""}async requestWebsite(r,e){let t=new S.default.Agent({keepAlive:!0,maxSockets:20}),o=new N.default.Agent({keepAlive:!0,maxSockets:20}),i={agent:s=>s.protocol=="http:"?t:o,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",Connection:"keep-alive",Cookie:`${this._cookies?this._cookiesJar.toString():""}`}},d=await(await(0,T.default)(`${r}`,e||i)).text();return E.load(d,{xmlMode:!0})}extractJSONObject(r){let e=r.split('<script id="__UNIVERSAL_DATA_FOR_REHYDRATION__" type="application/json">')[1].indexOf("<\/script>");return r.split('<script id="__UNIVERSAL_DATA_FOR_REHYDRATION__" type="application/json">')[1].slice(0,e)}checkJSONExisting(r){try{return!!JSON.parse(r)}catch{}}async requestWithPuppeteer(r){let e=await V.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]}),o=await(await e.newPage()).goto(r,{waitUntil:"domcontentloaded"});if(o==null)throw await e.close(),new Error("Could not load the desired Page!");let i=await o.text();return await e.close(),this.extractJSONObject(i)}async TryFetch(r){let e=await this.requestWebsite(r);if(this.checkJSONExisting(e("#__UNIVERSAL_DATA_FOR_REHYDRATION__").text()))return JSON.parse(e("#__UNIVERSAL_DATA_FOR_REHYDRATION__").text());{let t=await this.requestWithPuppeteer(r);return JSON.parse(t)}}async video(r,e){if(!r)throw new Error("A video URL must be provided");let t=await this.TryFetch(r),o=t.ItemList?.video?.list[0]??0;if(o==0)return console.log("Could not find the Video on Tiktok!");let i=e?await this.noWaterMark(r):t.ItemModule[o].video.playAddr.trim();return new p(o,t.ItemModule[o].desc,new Date(Number(t.ItemModule[o].createTime)*1e3).toLocaleDateString(),Number(t.ItemModule[o].video.height),Number(t.ItemModule[o].video.width),Number(t.ItemModule[o].video.duration),t.ItemModule[o].video.ratio,t.ItemModule[o].stats.shareCount,t.ItemModule[o].stats.diggCount,t.ItemModule[o].stats.commentCount,t.ItemModule[o].stats.playCount,i,t.ItemModule[o].video.cover,t.ItemModule[o].video.dynamicCover,i,t.ItemModule[o].video.format,t.ItemModule[o].author,`https://www.tiktok.com/@${t.ItemModule[o].author}/video/${o}`)}async user(r){if(!r)throw new Error("Please enter a username");let t=(await this.TryFetch(`https://www.tiktok.com/@${r}`)).__DEFAULT_SCOPE__["webapp.user-detail"].userInfo;return new f(t.user.id,t.user.uniqueId,t.user.nickname,t.user.avatarLarger,t.user.signature.trim(),new Date(t.user.createTime*1e3).toLocaleDateString(),t.user.verified,t.user.secUid,t.user.bioLink?.link,t.user.privateAccount,t.stats.followerCount,t.stats.followingCount,t.stats.heart,t.stats.videoCount)}async getAllVideosFromUser(r,e){if(!r)throw new Error("You must provide a username!");let{secretUID:t}=await this.user(`${r}`);if(!t)throw new Error("Couuld not find user UID!");let o="",i=[],u=[],d=await C(t,o);if(d?.itemList&&(u.push(d.itemList),o=d.cursor),d?.hasMore===!0)for(;;){let c=await C(t,o);if(u.push(c.itemList),o=c.cursor,c.hasMore==!1)break}for(let c of u)for(let s of c)i.push(new p(s.id,s.desc,new Date(Number(s.createTime)*1e3).toLocaleDateString(),Number(s.video?.height),Number(s.video?.width),Number(s.video?.duration),s.video?.ratio,s?.stats?.shareCount,s?.stats?.diggCount,s?.stats?.commentCount,s?.stats?.playCount,e?await this.noWaterMark(`https://www.tiktok.com/@${s.author.uniqueId}/video/${s.id}`):s.video?.downloadAddr.trim(),s?.video?.cover,s?.video?.dynamicCover,e?await this.noWaterMark(`https://www.tiktok.com/@${s.author.uniqueId}/video/${s.id}`):s.video?.downloadAddr.trim(),s?.video?.format,s.author,`https://www.tiktok.com/@${s.author.uniqueId}/video/${s.id}`));return i}async getMusic(r){if(!r)throw new Error("You must provide a link!");let e=await this.TryFetch(r),t=e.ItemList.video.list[0];return new b(e.ItemModule[t].music.id,e.ItemModule[t].music.title,e.ItemModule[t].music.playUrl,e.ItemModule[t].music.coverLarge,e.ItemModule[t].music.coverThumb,e.ItemModule[t].music.authorName,Number(e.ItemModule[t].music.duration),e.ItemModule[t].music.original,e.ItemModule[t].music.album)}async downloadAllVideosFromUser(r,e){if(!r)throw new Error("Please enter a username!");let t=await this.getAllVideosFromUser(r);if(!t)throw new Error("No Videos were found for this username. Either the videos are private or the user has not videos");if(!e.path){if(e.path=`${__dirname}/../${r}`,(0,h.existsSync)(e.path)){console.log("A folder with this username exists, that is unusual!");try{(0,h.unlinkSync)(e.path)}catch(o){console.log(`[ERROR] Could not remove ${e.path}
 Error Message: ${o.message}`),(0,O.exit)(1)}}(0,h.existsSync)(e.path)||(0,h.mkdirSync)(e.path)}if(e.watermark){for(let[o,i]of t.entries()){console.log(`Downloading Video: ${i.description?i.description:i.id}, [${o+1}/${t.length}]`);let u=await this.noWaterMark(i.id);if(!u){console.log(`Could not fetch ${i.description?i.description:i.id} with no watermark`);continue}(0,x.default)(u).pipe((0,h.createWriteStream)(`${e.path}/${i.id}_${i.resolution}.${i.format}`))}return}for(let[o,i]of t.entries())console.log(`Downloading Video: ${i.description?i.description:i.id}, [${o+1}/${t.length}]`),(0,x.default)(i.downloadURL).pipe((0,h.createWriteStream)(`${e.path}/${i.id}_${i.resolution}.${i.format}`))}async noWaterMark(r){let e={url:r,count:"12",cursor:"0",web:"1",hd:"1"},t=await(0,T.default)("https://www.tikwm.com/api/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(e).toString()});if(!t.ok)throw new Error("There was an Error retrieveing this video without watermark!");let o=await t.json();if(o.code===-1)throw new Error("API Limit for nowatermark, please wait 1 second and try again!");return"https://www.tikwm.com"+o.data.hdplay}async hashTag(r){if(!r)throw new Error("You must provide a tag name to complete the search!");let e=await this.TryFetch(`https://www.tiktok.com/tag/${r}`),{ItemList:t}=e,o=[];for(let i of t.challenge.list)o.push(new p(e.ItemModule[i].video.id,e.ItemModule[i].desc,new Date(Number(e.ItemModule[i].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[i].video.height),Number(e.ItemModule[i].video.width),Number(e.ItemModule[i].video.duration),e.ItemModule[i].video.ratio,e.ItemModule[i].stats.shareCount,e.ItemModule[i].stats.diggCount,e.ItemModule[i].stats.commentCount,e.ItemModule[i].stats.playCount,e.ItemModule[i].video.downloadAddr.trim(),e.ItemModule[i].video.cover,e.ItemModule[i].video.dynamicCover,e.ItemModule[i].video.playAddr.trim(),e.ItemModule[i].video.format,e.ItemModule[i].author));return o}};a(l,"TTScraper");async function Z(n,r){if(!n)throw new Error("You must provide a Tiktok video url!");return await new l().video(n,r)}a(Z,"fetchVideo");async function ee(n){if(!n)throw new Error("You must provide a username!");return await new l().user(n)}a(ee,"fetchUser");async function te(n,r){if(!n)throw new Error("You must provide a username!");return await new l().getAllVideosFromUser(n,r)}a(te,"fetchAllVideosFromUser");async function re(n){if(!n)throw new Error("You must provide a Tiktok video url!");return await new l().getMusic(n)}a(re,"fetchMusic");async function oe(n){if(!n)throw new Error("You must provide a Tiktok video url!");return await new l().noWaterMark(n)}a(oe,"fetchVideoNoWaterMark");async function ie(n){if(!n)throw new Error("You must provide a tiktok hashtag");return await new l().hashTag(n)}a(ie,"hashtag");module.exports=G(ne);0&&(module.exports={Music,TTScraper,TikTokResult,User,Video,fetchAllVideosFromUser,fetchMusic,fetchUser,fetchVideo,fetchVideoNoWaterMark,hashtag});
