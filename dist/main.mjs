var N=Object.defineProperty;var a=(s,r)=>N(s,"name",{value:r,configurable:!0}),O=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(r,e)=>(typeof require!="undefined"?require:r)[e]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});import{fileURLToPath as $}from"url";import D from"path";var q=a(()=>$(import.meta.url),"getFilename"),W=a(()=>D.dirname(q()),"getDirname"),m=W();import*as R from"cheerio";import y from"miniget";import C from"node-fetch";import{createWriteStream as x,existsSync as T,mkdirSync as z,unlinkSync as B}from"node:fs";import*as U from"puppeteer";import G from"node:http";import H from"node:https";import{exit as K}from"node:process";var w=class{constructor(r,e,t,i,o,u,d,c,n,g,b,v,I,k){this.id=r,this.uniqueId=e,this.nickname=t,this.avatar=i,this.signature=o,this.createdAt=u,this.verified=d,this.secretUID=c,this.bioLink=n,this.privateAccount=g,this.followers=b,this.following=v,this.hearts=I,this.videos=k}};a(w,"User");var _=class{constructor(r,e,t,i,o,u,d,c,n,g){this.author=r,this.video=e,this.audio=t,this.shareCount=i,this.likesCount=o,this.commentCount=u,this.playCount=d,this.createdAt=c,this.tiktokLink=n,this.thumbnail=g}};a(_,"TikTokResult");var p=class{constructor(r,e,t,i,o,u,d,c,n,g,b,v,I,k,L,E,V,S){this.id=r,this.description=e,this.createdAt=t,this.height=i,this.width=o,this.duration=u,this.resolution=d,this.shareCount=c,this.likesCount=n,this.commentCount=g,this.playCount=b,this.downloadURL=v,this.cover=I,this.dynamicCover=k,this.playURL=L,this.format=E,this.author=V,this.directVideoUrl=S}};a(p,"Video");var f=class{constructor(r,e,t,i,o,u,d,c,n){this.id=r,this.title=e,this.playURL=t,this.coverLarge=i,this.coverThumb=o,this.author=u,this.duration=d,this.original=c,this.album=n}};a(f,"Music");import{CookieJar as X}from"netscape-cookies-parser";import J from"node-fetch";var F=O("tiktok-signature"),P="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.56",j="https://www.tiktok.com/api/post/item_list/?aid=1988&app_language=en&app_name=tiktok_web&battery_info=1&browser_language=en-US&browser_name=Mozilla&browser_online=true&browser_platform=Win32&browser_version=5.0%20%28Windows%20NT%2010.0%3B%20Win64%3B%20x64%29%20AppleWebKit%2F537.36%20%28KHTML%2C%20like%20Gecko%29%20Chrome%2F107.0.0.0%20Safari%2F537.36%20Edg%2F107.0.1418.56&channel=tiktok_web&cookie_enabled=true&device_id=7165118680723998214&device_platform=web_pc&focus_state=true&from_page=user&history_len=3&is_fullscreen=false&is_page_visible=true&os=windows&priority_region=RO&referer=&region=RO&screen_height=1440&screen_width=2560&tz_name=Europe%2FBucharest&webcast_language=en&msToken=G3C-3f8JVeDj9OTvvxfaJ_NppXWzVflwP1dOclpUOmAv4WmejB8kFwndJufXBBrXbeWNqzJgL8iF5zn33da-ZlDihRoWRjh_TDSuAgqSGAu1-4u2YlvCATAM2jl2J1dwNPf0_fk9dx1gJxQ21S0=&X-Bogus=DFSzswVYxTUANS/JS8OTqsXyYJUo&_signature=_02B4Z6wo00001CoOkNwAAIDBCa--cQz5e0wqDpRAAGoE8f",A={aid:"1988",count:35,secUid:"",cursor:"",cookie_enabled:!0,screen_width:0,screen_height:0,browser_language:"",browser_platform:"",browser_name:"",browser_version:"",browser_online:"",timezone_name:"Europe/London"};async function M(s,r){A.secUid=s,A.cursor=r;let e=new F(null,P);await e.init();let o=`https://m.tiktok.com/api/post/item_list/?${new URLSearchParams(A).toString()}`,u=await e.sign(o),d=await e.navigator();await e.close();let{"x-tt-params":c}=u,{user_agent:n}=d,g=await Y(n,c);if(g.status!==200)throw new Error("A request to get the user's videos was not successful!");return await g.json()}a(M,"getUserVideos");async function Y(s,r){return await J(j,{method:"GET",headers:{"user-agent":s,"x-tt-params":r}})}a(Y,"fetchVideos");var h=class{constructor(r){this._cookiesJar=new X;r?this._cookies=this._cookiesJar.load(r):this._cookies=""}async requestWebsite(r,e){let t=new G.Agent({keepAlive:!0,maxSockets:20}),i=new H.Agent({keepAlive:!0,maxSockets:20}),o={agent:n=>n.protocol=="http:"?t:i,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",Connection:"keep-alive",Cookie:`${this._cookies?this._cookiesJar.toString():""}`}},d=await(await C(`${r}`,e||o)).text();return R.load(d,{xmlMode:!0})}extractJSONObject(r){let e=r.split('<script id="__UNIVERSAL_DATA_FOR_REHYDRATION__" type="application/json">')[1].indexOf("<\/script>");return r.split('<script id="__UNIVERSAL_DATA_FOR_REHYDRATION__" type="application/json">')[1].slice(0,e)}checkJSONExisting(r){try{return!!JSON.parse(r)}catch{}}async requestWithPuppeteer(r){let e=await U.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]}),i=await(await e.newPage()).goto(r,{waitUntil:"domcontentloaded"});if(i==null)throw await e.close(),new Error("Could not load the desired Page!");let o=await i.text();return await e.close(),this.extractJSONObject(o)}async TryFetch(r){let e=await this.requestWebsite(r);if(this.checkJSONExisting(e("#__UNIVERSAL_DATA_FOR_REHYDRATION__").text()))return JSON.parse(e("#__UNIVERSAL_DATA_FOR_REHYDRATION__").text());{let t=await this.requestWithPuppeteer(r);return JSON.parse(t)}}async video(r,e){if(!r)throw new Error("A video URL must be provided");let t=await this.TryFetch(r),i=t.ItemList?.video?.list[0]??0;if(i==0)return console.log("Could not find the Video on Tiktok!");let o=e?await this.noWaterMark(r):t.ItemModule[i].video.playAddr.trim();return new p(i,t.ItemModule[i].desc,new Date(Number(t.ItemModule[i].createTime)*1e3).toLocaleDateString(),Number(t.ItemModule[i].video.height),Number(t.ItemModule[i].video.width),Number(t.ItemModule[i].video.duration),t.ItemModule[i].video.ratio,t.ItemModule[i].stats.shareCount,t.ItemModule[i].stats.diggCount,t.ItemModule[i].stats.commentCount,t.ItemModule[i].stats.playCount,o,t.ItemModule[i].video.cover,t.ItemModule[i].video.dynamicCover,o,t.ItemModule[i].video.format,t.ItemModule[i].author,`https://www.tiktok.com/@${t.ItemModule[i].author}/video/${i}`)}async user(r){if(!r)throw new Error("Please enter a username");let t=(await this.TryFetch(`https://www.tiktok.com/@${r}`)).__DEFAULT_SCOPE__["webapp.user-detail"].userInfo;return new w(t.user.id,t.user.uniqueId,t.user.nickname,t.user.avatarLarger,t.user.signature.trim(),new Date(t.user.createTime*1e3).toLocaleDateString(),t.user.verified,t.user.secUid,t.user.bioLink?.link,t.user.privateAccount,t.stats.followerCount,t.stats.followingCount,t.stats.heart,t.stats.videoCount)}async getAllVideosFromUser(r,e){if(!r)throw new Error("You must provide a username!");let{secretUID:t}=await this.user(`${r}`);if(!t)throw new Error("Couuld not find user UID!");let i="",o=[],u=[],d=await M(t,i);if(d?.itemList&&(u.push(d.itemList),i=d.cursor),d?.hasMore===!0)for(;;){let c=await M(t,i);if(u.push(c.itemList),i=c.cursor,c.hasMore==!1)break}for(let c of u)for(let n of c)o.push(new p(n.id,n.desc,new Date(Number(n.createTime)*1e3).toLocaleDateString(),Number(n.video?.height),Number(n.video?.width),Number(n.video?.duration),n.video?.ratio,n?.stats?.shareCount,n?.stats?.diggCount,n?.stats?.commentCount,n?.stats?.playCount,e?await this.noWaterMark(`https://www.tiktok.com/@${n.author.uniqueId}/video/${n.id}`):n.video?.downloadAddr.trim(),n?.video?.cover,n?.video?.dynamicCover,e?await this.noWaterMark(`https://www.tiktok.com/@${n.author.uniqueId}/video/${n.id}`):n.video?.downloadAddr.trim(),n?.video?.format,n.author,`https://www.tiktok.com/@${n.author.uniqueId}/video/${n.id}`));return o}async getMusic(r){if(!r)throw new Error("You must provide a link!");let e=await this.TryFetch(r),t=e.ItemList.video.list[0];return new f(e.ItemModule[t].music.id,e.ItemModule[t].music.title,e.ItemModule[t].music.playUrl,e.ItemModule[t].music.coverLarge,e.ItemModule[t].music.coverThumb,e.ItemModule[t].music.authorName,Number(e.ItemModule[t].music.duration),e.ItemModule[t].music.original,e.ItemModule[t].music.album)}async downloadAllVideosFromUser(r,e){if(!r)throw new Error("Please enter a username!");let t=await this.getAllVideosFromUser(r);if(!t)throw new Error("No Videos were found for this username. Either the videos are private or the user has not videos");if(!e.path){if(e.path=`${m}/../${r}`,T(e.path)){console.log("A folder with this username exists, that is unusual!");try{B(e.path)}catch(i){console.log(`[ERROR] Could not remove ${e.path}
 Error Message: ${i.message}`),K(1)}}T(e.path)||z(e.path)}if(e.watermark){for(let[i,o]of t.entries()){console.log(`Downloading Video: ${o.description?o.description:o.id}, [${i+1}/${t.length}]`);let u=await this.noWaterMark(o.id);if(!u){console.log(`Could not fetch ${o.description?o.description:o.id} with no watermark`);continue}y(u).pipe(x(`${e.path}/${o.id}_${o.resolution}.${o.format}`))}return}for(let[i,o]of t.entries())console.log(`Downloading Video: ${o.description?o.description:o.id}, [${i+1}/${t.length}]`),y(o.downloadURL).pipe(x(`${e.path}/${o.id}_${o.resolution}.${o.format}`))}async noWaterMark(r){let e={url:r,count:"12",cursor:"0",web:"1",hd:"1"},t=await C("https://www.tikwm.com/api/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(e).toString()});if(!t.ok)throw new Error("There was an Error retrieveing this video without watermark!");let i=await t.json();if(i.code===-1)throw new Error("API Limit for nowatermark, please wait 1 second and try again!");return"https://www.tikwm.com"+i.data.hdplay}async hashTag(r){if(!r)throw new Error("You must provide a tag name to complete the search!");let e=await this.TryFetch(`https://www.tiktok.com/tag/${r}`),{ItemList:t}=e,i=[];for(let o of t.challenge.list)i.push(new p(e.ItemModule[o].video.id,e.ItemModule[o].desc,new Date(Number(e.ItemModule[o].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[o].video.height),Number(e.ItemModule[o].video.width),Number(e.ItemModule[o].video.duration),e.ItemModule[o].video.ratio,e.ItemModule[o].stats.shareCount,e.ItemModule[o].stats.diggCount,e.ItemModule[o].stats.commentCount,e.ItemModule[o].stats.playCount,e.ItemModule[o].video.downloadAddr.trim(),e.ItemModule[o].video.cover,e.ItemModule[o].video.dynamicCover,e.ItemModule[o].video.playAddr.trim(),e.ItemModule[o].video.format,e.ItemModule[o].author));return i}};a(h,"TTScraper");async function qe(s,r){if(!s)throw new Error("You must provide a Tiktok video url!");return await new h().video(s,r)}a(qe,"fetchVideo");async function We(s){if(!s)throw new Error("You must provide a username!");return await new h().user(s)}a(We,"fetchUser");async function Fe(s,r){if(!s)throw new Error("You must provide a username!");return await new h().getAllVideosFromUser(s,r)}a(Fe,"fetchAllVideosFromUser");async function Je(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new h().getMusic(s)}a(Je,"fetchMusic");async function Pe(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new h().noWaterMark(s)}a(Pe,"fetchVideoNoWaterMark");async function je(s){if(!s)throw new Error("You must provide a tiktok hashtag");return await new h().hashTag(s)}a(je,"hashtag");export{f as Music,h as TTScraper,_ as TikTokResult,w as User,p as Video,Fe as fetchAllVideosFromUser,Je as fetchMusic,We as fetchUser,qe as fetchVideo,Pe as fetchVideoNoWaterMark,je as hashtag};
